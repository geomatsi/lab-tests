# -*- python -*-
# ex: set filetype=python:

from buildbot.plugins import *

####### GLOBALS

#KERNEL_REPO  = 'git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git',
#KERNEL_REPO  = 'https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git',
KERNEL_REPO   = 'https://github.com/torvalds/linux.git'
OPENSBI_REPO  = 'https://github.com/riscv/opensbi.git'

ENABLE_HARDWARE_TESTS = False
ENABLE_QEMU_TESTS = True

####### BUILDMASTER

c = BuildmasterConfig = {}

# project identity
c['buildbotURL'] = "http://webb:8010/"
c['titleURL'] = "https://buildbot.github.io/hello-world/"
c['title'] = "Labgrid tests"

# database URL
c['db'] = {
    'db_url' : "sqlite:///state.sqlite",
}

# minimalistic config to activate new web UI
c['www'] = dict(port=8010, plugins=dict(waterfall_view={}, console_view={}, grid_view={}))
c['protocols'] = {'pb': {'port': 9989}}
c['services'] = []

# building blocks
c['change_source'] = []
c['schedulers'] = []
c['builders'] = []
c['projects'] = []
c['workers'] = []

# projects
c['projects'].append(util.Project(name="RISC-V", description="Automated tests of Linux kernel for RISC-V architecture"))
c['projects'].append(util.Project(name="SUNXI", description="Automated tests of Linux kernel for sunxi platforms"))

# workers
c['workers'].append(worker.Worker("builder1", "topsecret"))
c['workers'].append(worker.Worker("tester1", "topsecret"))

####### TESTLAB

# TODO: not used at the moment
lab = {
    "slot1": {
        "enabled" : True,
        "board"   : "BananPi CanMV K230D",
        "ipaddr"  : "192.168.1.10",
        "default" : "artifacts/images/default/slot1",
        "kernel"  : "Image",
        "dtb"     : "bananapi-canmv-k230d-zero.dtb",
    },
    "slot2": {
        "enabled" : True,
        "board"   : "OrangePi PC Plus",
        "ipaddr"  : "192.168.1.20",
        "default" : "artifacts/images/default/slot2",
        "kernel"  : "zImage",
        "dtb"     : "sun8i-h3-orangepi-pc-plus.dtb",
    },
    "slot3": {
        "enabled" : True,
        "board"   : "MangoPi MQ Pro",
        "ipaddr"  : None,
        "default" : "artifacts/images/default/slot3",
        "fsbl"    : "jump.bin",
        "opensbi" : "fw_jump.bin",
        "kernel"  : "Image",
        "dtb"     : "sun20i-d1-mangopi-mq-pro.dtb",
    },
    "slot4": {
        "enabled" : False,
    },
    "slot5": {
        "enabled" : True,
        "board"   : "OrangePi RV",
        "ipaddr"  : "192.168.1.50",
        "default" : "artifacts/images/default/slot5",
        "kernel"  : "Image",
        "dtb"     : "jh7110-orangepi-rv.dtb",

    },
    "slot6": {
        "enabled" : True,
        "board"   : "Sipeed Maix Bit",
        "ipaddr"  : None,
        "default" : "artifacts/images/default/slot6",
        "kernel"  : "loader.bin",
        "dtb"     : None,
    },
    "slot7": {
        "enabled" : False,
    },
    "slot8": {
        "enabled" : True,
        "board"   : "Sipeed LicheePi 4A",
        "ipaddr"  : "192.168.1.80",
        "default" : "artifacts/images/default/slot8",
        "kernel"  : "Image",
        "dtb"     : "th1520-lichee-pi-4a.dtb",
    },
}

##############################################################
#################### COMMON BITS
##############################################################

####### CHANGESOURCES

c['change_source'].append(changes.GitPoller(
        KERNEL_REPO,
        workdir='gitpoller-workdir', branch='master',
        pollAtLaunch=True, pollInterval=3600,
        category='kernel'))

c['change_source'].append(changes.GitPoller(
        OPENSBI_REPO,
        workdir='gitpoller-workdir', branch='master',
        pollAtLaunch=True, pollInterval=3600,
        category='opensbi'))

##############################################################
#################### PROJECT: RISC-V
##############################################################

####### SCHEDULERS

# schedule builds based on source changes

@util.renderer
def select_riscv_kernel_builders(props):
    props.setProperty('HARDWARE_TESTS', ENABLE_HARDWARE_TESTS, 'select_riscv_kernel_builders')
    props.setProperty('QEMU_TESTS', ENABLE_QEMU_TESTS, 'select_riscv_kernel_builders')
    builders = set()

    print("----------------  Changed files")

    for fn in props.files:
        print(f"  {fn}")
        #if fn.startswith("arch/riscv/"):
        #    builders.add('riscv64-kernel-build')
        #    builders.add('riscv32-kernel-build')
        #    builders.add('riscv-nommu-kernel-build')

    # for now kick riscv64 kernel builds for any kernel changes
    builders.add('riscv64-kernel-build')
    builders.add('riscv32-kernel-build')
    builders.add('riscv-nommu-kernel-build')
    builders.add('kernel-poll')

    print(f"expected builders: {list(builders)}")
    return list(builders)

c['schedulers'].append(schedulers.SingleBranchScheduler(
                            name="riscv-kernel-master-scheduler",
                            change_filter=util.ChangeFilter(branch='master', category='kernel'),
                            builderNames=select_riscv_kernel_builders))

@util.renderer
def select_opensbi_builders(props):
    props.setProperty('HARDWARE_TESTS', ENABLE_HARDWARE_TESTS, 'select_opensbi_builders')
    props.setProperty('QEMU_TESTS', ENABLE_QEMU_TESTS, 'select_opensbi_builders')
    builders = set()

    builders.add('opensbi-build')
    builders.add('opensbi-poll')

    print(f"expected builders: {list(builders)}")
    return list(builders)

c['schedulers'].append(schedulers.SingleBranchScheduler(
                            name="opensbi-master-scheduler",
                            change_filter=util.ChangeFilter(branch='master', category='opensbi'),
                            builderNames=select_opensbi_builders))

# schedule builds and tests on demands

c['schedulers'].append(schedulers.ForceScheduler(
                            name="force-riscv64-kernel-build",
                            properties=[
                                util.BooleanParameter(name="HARDWARE_TESTS", label="Run hardware tests", default=False),
                                util.BooleanParameter(name="QEMU_TESTS", label="Run QEMU tests", default=False),
                            ],
                            builderNames=["riscv64-kernel-build", "kernel-poll"]))

c['schedulers'].append(schedulers.ForceScheduler(
                            name="force-riscv32-kernel-build",
                            properties=[
                                util.BooleanParameter(name="HARDWARE_TESTS", label="Run hardware tests", default=False),
                                util.BooleanParameter(name="QEMU_TESTS", label="Run QEMU tests", default=False),
                            ],
                            builderNames=["riscv32-kernel-build", "kernel-poll"]))

c['schedulers'].append(schedulers.ForceScheduler(
                            name="force-riscv-nommu-kernel-build",
                            properties=[
                                util.BooleanParameter(name="HARDWARE_TESTS", label="Run hardware tests", default=False),
                                util.BooleanParameter(name="QEMU_TESTS", label="Run QEMU tests", default=False),
                            ],
                            builderNames=["riscv-nommu-kernel-build", "kernel-poll"]))

c['schedulers'].append(schedulers.ForceScheduler(
                            name="force-opensbi-build",
                            properties=[
                                util.BooleanParameter(name="HARDWARE_TESTS", label="Run hardware tests", default=False),
                                util.BooleanParameter(name="QEMU_TESTS", label="Run QEMU tests", default=False),
                            ],
                            builderNames=["opensbi-build", "opensbi-poll"]))

c['schedulers'].append(schedulers.ForceScheduler(
                            name="force-riscv-qemu-test",
                            properties=[
                                util.BooleanParameter(name="DEFAULT_IMAGES", label="Use default images", default=False),
                            ],
                            builderNames=[
                                "test-qemu1-riscv64",
                                "test-qemu2-riscv64",
                                "test-qemu3-riscv32",
                                "test-qemu4-riscv32",
                                "test-qemu5-riscv64-nommu",
                                "test-qemu6-riscv32-nommu",
                                "kernel-poll"
                            ]))

c['schedulers'].append(schedulers.ForceScheduler(
                            name="force-riscv-lab-tests",
                            properties=[
                                util.BooleanParameter(name="DEFAULT_IMAGES", label="Use default images", default=False),
                            ],
                            builderNames=[
                                'test-mangopi-mqpro',
                                'test-orangepi-rv',
                                'test-sipeed-maixbit',
                                'test-sipeed-lpi4a',
                                'test-bananapi-canmv-k230d-zero',
                            ]))

# trigger builds and tests from other builders

c['schedulers'].append(schedulers.Triggerable(
    name='riscv64-lab-test-scheduler',
    builderNames=['test-mangopi-mqpro', 'test-sipeed-lpi4a', 'test-orangepi-rv', 'test-bananapi-canmv-k230d-zero']))

c['schedulers'].append(schedulers.Triggerable(
    name='riscv64-qemu-test-scheduler',
    builderNames=['test-qemu1-riscv64', 'test-qemu2-riscv64']))

# TODO: currently no rv32 board in the lab
c['schedulers'].append(schedulers.Triggerable(
    name='riscv32-lab-test-scheduler',
    builderNames=[]))

c['schedulers'].append(schedulers.Triggerable(
    name='riscv32-qemu-test-scheduler',
    builderNames=['test-qemu3-riscv32', 'test-qemu4-riscv32']))

c['schedulers'].append(schedulers.Triggerable(
    name='riscv-nommu-lab-test-scheduler',
    builderNames=['test-sipeed-maixbit']))

c['schedulers'].append(schedulers.Triggerable(
    name='riscv-nommu-qemu-test-scheduler',
    builderNames=['test-qemu5-riscv64-nommu', 'test-qemu6-riscv32-nommu']))

c['schedulers'].append(schedulers.Triggerable(
    name='opensbi-lab-test-scheduler',
    builderNames=['test-mangopi-mqpro']))

c['schedulers'].append(schedulers.Triggerable(
    name='opensbi-qemu-test-scheduler',
    # test both new OpenSBI and QEMU default OpenSBI to allow comparison in the case of failures
    builderNames=[
        'test-qemu1-riscv64',
        'test-qemu2-riscv64',
        'test-qemu3-riscv32',
        'test-qemu4-riscv32',
    ]))

####### BUILDERS

#### 'DEBUG' builders

## track kernel changes

factory00_0 = util.BuildFactory()

factory00_0.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=["echo", "DEFAULT_IMAGES=", util.Interpolate("%(prop:DEFAULT_IMAGES)s", default='False')], logname="test1"),
        util.ShellArg(command=["echo", "HARDWARE_TESTS=", util.Interpolate('%(prop:HARDWARE_TESTS)s', default='None')], logname="test2"),
        util.ShellArg(command=["echo", "QEMU_TESTS=", util.Interpolate('%(prop:QEMU_TESTS)s', default='None')], logname="test3"),
    ]
))

factory00_0.addStep(steps.ShellCommand(
    command=["echo", "HARDWARE_TESTS=", util.Interpolate('%(prop:HARDWARE_TESTS)s')],
    doStepIf=lambda step: step.build.getProperty('HARDWARE_TESTS', default=False),
))

factory00_0.addStep(steps.ShellCommand(
    command=["echo", "QEMU_TESTS=", util.Interpolate('%(prop:QEMU_TESTS)s')],
    doStepIf=lambda step: step.build.getProperty('QEMU_TESTS', default=False),
))

factory00_0.addStep(steps.ShellCommand(
    command=['date']
))

c['builders'].append(
    util.BuilderConfig(
        name="kernel-poll",
        workernames=["builder1"],
        factory=factory00_0))

## track opensbi changes

factory00_1 = util.BuildFactory()

factory00_1.addStep(steps.ShellCommand(
    command=['date']
))

c['builders'].append(
    util.BuilderConfig(
        name="opensbi-poll",
        workernames=["builder1"],
        factory=factory00_1))

#### 'BUILD' builders

#
# builder: build riscv64 kernel images
# - defconfig
#

riscv64_kernel_factory = util.BuildFactory()

riscv64_kernel_factory.addStep(steps.Git(repourl=KERNEL_REPO,
                           alwaysUseLatest=True,
                           mode='full',
                           method='fresh'))

#### defconfig

riscv64_kernel_factory.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc="artifacts/images/rootfs/rootfs.cpio.rv64.generic",
    workerdest="rootfs.cpio"))

riscv64_kernel_factory.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['make', 'distclean'], logname='distclean'),
        util.ShellArg(command=['make', 'defconfig'], logname='configure'),
        util.ShellArg(command=['./scripts/config', '--set-str','CONFIG_INITRAMFS_SOURCE', 'rootfs.cpio'], logname='tune kernel config'),
        util.ShellArg(command=['./scripts/config', '-e','CONFIG_INITRAMFS_COMPRESSION_NONE'], logname='tune kernel config'),
        util.ShellArg(command=['./scripts/config', '-e','CONFIG_USB_DWC2'], logname='tune kernel config'),
        util.ShellArg(command=['./scripts/config', '-e','CONFIG_USB_RTL8152=y'], logname='tune kernel config'),
        util.ShellArg(command=['make', 'CONFIG_INITRAMFS_SOURCE=rootfs.cpio'], logname='tune kernel config'),
        util.ShellArg(command=['make', 'olddefconfig'], logname='olddefconfig'),
        util.ShellArg(command=['make', '-j5'], logname='build kernel'),
        util.ShellArg(command=['make', 'allwinner/sun20i-d1-mangopi-mq-pro.dtb'], logname='build mangopi mq pro dtb'),
        util.ShellArg(command=['make', 'thead/th1520-lichee-pi-4a.dtb'], logname='build lpi4a dtb'),
    ],
    env={
        "ARCH": "riscv",
        "CROSS_COMPILE": "/home/matsi/devel2/tools/bootlin/riscv64-lp64d--glibc--bleeding-edge-2025.08-1/bin/riscv64-linux-"
    }))

## copy to the build artifacts

riscv64_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/Image",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image'),
    mode=0o755))

riscv64_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/dts/allwinner/sun20i-d1-mangopi-mq-pro.dtb",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/sun20i-d1-mangopi-mq-pro.dtb'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/sun20i-d1-mangopi-mq-pro.dtb'),
    mode=0o755))

riscv64_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/dts/thead/th1520-lichee-pi-4a.dtb",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/th1520-lichee-pi-4a.dtb'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/th1520-lichee-pi-4a.dtb'),
    mode=0o755))

## copy to the latest artifacts

# - FIXME: lock needed for the 'latest' directory
riscv64_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/Image",
    masterdest=util.Interpolate('artifacts/latest/riscv64/Image'),
    url=util.Interpolate('artifacts/latest/riscv64/Image'),
    mode=0o755))

riscv64_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/dts/allwinner/sun20i-d1-mangopi-mq-pro.dtb",
    masterdest=util.Interpolate('artifacts/latest/riscv64/sun20i-d1-mangopi-mq-pro.dtb'),
    url=util.Interpolate('artifacts/latest/riscv64/sun20i-d1-mangopi-mq-pro.dtb'),
    mode=0o755))

riscv64_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/dts/thead/th1520-lichee-pi-4a.dtb",
    masterdest=util.Interpolate('artifacts/latest/riscv64/th1520-lichee-pi-4a.dtb'),
    url=util.Interpolate('artifacts/latest/riscv64/th1520-lichee-pi-4a.dtb'),
    mode=0o755))

#### trigger tests

riscv64_kernel_factory.addStep(steps.Trigger(
    schedulerNames=['riscv64-lab-test-scheduler'],
    set_properties={
        'sun20i-d1-mangopi-mq-pro.dtb': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/sun20i-d1-mangopi-mq-pro.dtb'),
        'th1520-lichee-pi-4a.dtb': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/th1520-lichee-pi-4a.dtb'),
        'Image': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image'),
    },
    doStepIf=lambda step: step.build.getProperty('HARDWARE_TESTS', default=False),
    waitForFinish=False))

riscv64_kernel_factory.addStep(steps.Trigger(
    schedulerNames=['riscv64-qemu-test-scheduler'],
    set_properties={
        'Image': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image'),
    },
    doStepIf=lambda step: step.build.getProperty('QEMU_TESTS', default=False),
    waitForFinish=False))

c['builders'].append(
    util.BuilderConfig(
        name="riscv64-kernel-build",
        project="RISC-V",
        workernames=["builder1"],
        factory=riscv64_kernel_factory))

#
# builder: build riscv32 kernel images
# - rv32_defconfig
#

riscv32_kernel_factory = util.BuildFactory()

riscv32_kernel_factory.addStep(steps.Git(repourl=KERNEL_REPO,
                           alwaysUseLatest=True,
                           mode='full',
                           method='fresh'))

#### rv32_defconfig

riscv32_kernel_factory.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc="artifacts/images/rootfs/rootfs.cpio.rv32.generic",
    workerdest="rootfs.cpio"))

riscv32_kernel_factory.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['make', 'distclean'], logname='distclean'),
        util.ShellArg(command=['make', 'rv32_defconfig'], logname='configure'),
        util.ShellArg(command=['make', 'CONFIG_INITRAMFS_SOURCE=rootfs.cpio', '-j5'], logname='build kernel'),
    ],
    env={
        "ARCH": "riscv",
        "CROSS_COMPILE": "/home/matsi/devel2/tools/bootlin/riscv64-lp64d--glibc--bleeding-edge-2025.08-1/bin/riscv64-linux-"
    }))

## copy to the build artifacts

riscv32_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/Image",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image'),
    mode=0o755))

## copy to the latest artifacts

# - FIXME: lock needed for the 'latest' directory
riscv32_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/Image",
    masterdest=util.Interpolate('artifacts/latest/riscv32/Image'),
    url=util.Interpolate('artifacts/latest/riscv32/Image'),
    mode=0o755))

## trigger tests

riscv32_kernel_factory.addStep(steps.Trigger(
    schedulerNames=['riscv32-lab-test-scheduler'],
    set_properties={
        'Image': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image'),
    },
    doStepIf=lambda step: step.build.getProperty('HARDWARE_TESTS', default=False),
    waitForFinish=False))

riscv32_kernel_factory.addStep(steps.Trigger(
    schedulerNames=['riscv32-qemu-test-scheduler'],
    set_properties={
        'Image': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image'),
    },
    doStepIf=lambda step: step.build.getProperty('QEMU_TESTS', default=False),
    waitForFinish=False))

c['builders'].append(
    util.BuilderConfig(
        name="riscv32-kernel-build",
        project="RISC-V",
        workernames=["builder1"],
        factory=riscv32_kernel_factory))

#
# builder: build riscv nommu kernel images
# - nommu_k210_defconfig
# - nommu_virt_defconfig
# - rv32_nommu_virt_defconfig
#

riscv_nommu_kernel_factory = util.BuildFactory()

riscv_nommu_kernel_factory.addStep(steps.Git(repourl=KERNEL_REPO,
                           alwaysUseLatest=True,
                           mode='full',
                           method='fresh'))

#### nommu_k210_defconfig

riscv_nommu_kernel_factory.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc="artifacts/images/rootfs/rootfs.cpio.rv64.nommu",
    workerdest="rootfs.cpio"))

riscv_nommu_kernel_factory.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['make', 'distclean'], logname='distclean'),
        util.ShellArg(command=['make', 'nommu_k210_defconfig'], logname='configure'),
        util.ShellArg(command=['make', 'CONFIG_INITRAMFS_SOURCE=rootfs.cpio', '-j5'], logname='build kernel'),
    ],
    env={
        "ARCH": "riscv",
        "CROSS_COMPILE": "/home/matsi/devel2/tools/bootlin/riscv64-lp64d--glibc--bleeding-edge-2025.08-1/bin/riscv64-linux-"
    }))

## copy to the build artifacts

riscv_nommu_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/loader.bin",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/loader.bin.k210'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/loader.bin.k210'),
    mode=0o755))

## copy to the latest artifacts

# - FIXME: lock needed for the 'latest' directory
riscv_nommu_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/loader.bin",
    masterdest=util.Interpolate('artifacts/latest/riscv-nommu/loader.bin.k210'),
    url=util.Interpolate('artifacts/latest/riscv-nommu/loader.bin.k210'),
    mode=0o755))

#### nommu_virt_defconfig

riscv_nommu_kernel_factory.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc="artifacts/images/rootfs/rootfs.cpio.rv64.nommu",
    workerdest="rootfs.cpio"))

riscv_nommu_kernel_factory.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['make', 'distclean'], logname='clean'),
        util.ShellArg(command=['make', 'nommu_virt_defconfig'], logname='configure'),
        util.ShellArg(command=['make', 'CONFIG_INITRAMFS_SOURCE=rootfs.cpio', '-j5'], logname='build kernel'),
    ],
    env={
        "ARCH": "riscv",
        "CROSS_COMPILE": "/home/matsi/devel2/tools/bootlin/riscv64-lp64d--glibc--bleeding-edge-2025.08-1/bin/riscv64-linux-"
    }))

## copy to the build artifacts

riscv_nommu_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/Image",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image.nommu.rv64'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image.nommu.rv64'),
    mode=0o755))

## copy to the latest artifacts

# - FIXME: lock needed for the 'latest' directory
riscv_nommu_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/Image",
    masterdest=util.Interpolate('artifacts/latest/riscv-nommu/Image.nommu.rv64'),
    url=util.Interpolate('artifacts/latest/riscv-nommu/Image.nommu.rv64'),
    mode=0o755))

#### rv32_nommu_virt_defconfig

riscv_nommu_kernel_factory.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc="artifacts/images/rootfs/rootfs.cpio.rv32.nommu",
    workerdest="rootfs.cpio"))

riscv_nommu_kernel_factory.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['make', 'distclean'], logname='clean'),
        util.ShellArg(command=['make', 'rv32_nommu_virt_defconfig'], logname='configure'),
        util.ShellArg(command=['make', 'CONFIG_INITRAMFS_SOURCE=rootfs.cpio', '-j5'], logname='build kernel'),
    ],
    env={
        "ARCH": "riscv",
        "CROSS_COMPILE": "/home/matsi/devel2/tools/bootlin/riscv64-lp64d--glibc--bleeding-edge-2025.08-1/bin/riscv64-linux-"
    }))

## copy to the build artifacts

riscv_nommu_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/Image",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image.nommu.rv32'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image.nommu.rv32'),
    mode=0o755))

## copy to the latest artifacts

# - FIXME: lock needed for the 'latest' directory
riscv_nommu_kernel_factory.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/riscv/boot/Image",
    masterdest=util.Interpolate('artifacts/latest/riscv-nommu/Image.nommu.rv32'),
    url=util.Interpolate('artifacts/latest/riscv-nommu/Image.nommu.rv32'),
    mode=0o755))


#### trigger tests

riscv_nommu_kernel_factory.addStep(steps.Trigger(
    schedulerNames=['riscv-nommu-lab-test-scheduler'],
    set_properties={
        'loader.bin.k210': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/loader.bin.k210'),
    },
    doStepIf=lambda step: step.build.getProperty('HARDWARE_TESTS', default=False),
    waitForFinish=False))

riscv_nommu_kernel_factory.addStep(steps.Trigger(
    schedulerNames=['riscv-nommu-qemu-test-scheduler'],
    set_properties={
        'Image.nommu.rv64': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image.nommu.rv64'),
        'Image.nommu.rv32': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/Image.nommu.rv32'),
    },
    doStepIf=lambda step: step.build.getProperty('QEMU_TESTS', default=False),
    waitForFinish=False))

c['builders'].append(
    util.BuilderConfig(
        name="riscv-nommu-kernel-build",
        project="RISC-V",
        workernames=["builder1"],
        factory=riscv_nommu_kernel_factory))

#
# builder: build opensbi images
#

riscv_factory02 = util.BuildFactory()

riscv_factory02.addStep(steps.Git(repourl=OPENSBI_REPO,
                           alwaysUseLatest=True,
                           mode='full',
                           method='fresh'))

#### opensbi riscv64 generic

riscv_factory02.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
        util.ShellArg(command=['make'], logname='opensbi'),
    ],
    env={
        "ARCH": "riscv",
        "PLATFORM": "generic",
        "CROSS_COMPILE": "/home/matsi/devel2/tools/bootlin/riscv64-lp64d--glibc--bleeding-edge-2025.08-1/bin/riscv64-linux-"
    }))

## copy to the build artifacts

riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_jump.bin",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin'),
    mode=0o755))

riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_dynamic.bin",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_dynamic.bin'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_dynamic.bin'),
    mode=0o755))

## copy to the latest artifacts

# - TODO: need lock for the 'latest' directory
riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_jump.bin",
    masterdest=util.Interpolate('artifacts/latest/riscv64/fw_jump.bin'),
    url=util.Interpolate('artifacts/latest/riscv64/fw_jump.bin'),
    mode=0o755))

riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_dynamic.bin",
    masterdest=util.Interpolate('artifacts/latest/riscv64/fw_dynamic.bin'),
    url=util.Interpolate('artifacts/latest/riscv64/fw_dynamic.bin'),
    mode=0o755))

#### opensbi riscv64 mangopi: custom jump fdt offset

riscv_factory02.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
        util.ShellArg(command=['make'], logname='opensbi'),
    ],
    env={
        "ARCH": "riscv",
        "PLATFORM": "generic",
        # custom fw_jump.bin for MangoPi MQPro FEL boot
        "FW_JUMP_FDT_OFFSET": "0x8200000",
        "CROSS_COMPILE": "/home/matsi/devel2/tools/bootlin/riscv64-lp64d--glibc--bleeding-edge-2025.08-1/bin/riscv64-linux-"
    }))

## copy to the build artifacts

riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_jump.bin",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin.mango'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin.mango'),
    mode=0o755))

## copy to the latest artifacts

# FIXME: lock needed for the shared 'latest' directory
riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_jump.bin",
    masterdest=util.Interpolate('artifacts/latest/riscv64/fw_jump.bin.mango'),
    url=util.Interpolate('artifacts/latest/riscv64/fw_jump.bin.mango'),
    mode=0o755))

#### opensbi riscv32 generic

riscv_factory02.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
        util.ShellArg(command=['make'], logname='opensbi'),
    ],
    env={
        "ARCH": "riscv",
        "PLATFORM": "generic",
        "PLATFORM_RISCV_XLEN": "32",
        "CROSS_COMPILE": "/home/matsi/devel2/tools/bootlin/riscv64-lp64d--glibc--bleeding-edge-2025.08-1/bin/riscv64-linux-"
    }))

## copy to the build artifacts

riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_jump.bin",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin.rv32'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin.rv32'),
    mode=0o755))

riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_dynamic.bin",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_dynamic.bin.rv32'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_dynamic.bin.rv32'),
    mode=0o755))

## copy to the latest artifacts

# - TODO: need lock for the 'latest' directory
riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_jump.bin",
    masterdest=util.Interpolate('artifacts/latest/riscv32/fw_jump.bin'),
    url=util.Interpolate('artifacts/latest/riscv32/fw_jump.bin'),
    mode=0o755))

riscv_factory02.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="build/platform/generic/firmware/fw_dynamic.bin",
    masterdest=util.Interpolate('artifacts/latest/riscv32/fw_dynamic.bin'),
    url=util.Interpolate('artifacts/latest/riscv32/fw_dynamic.bin'),
    mode=0o755))

#### trigger tests

riscv_factory02.addStep(steps.Trigger(
    schedulerNames=['opensbi-qemu-test-scheduler'],
    set_properties={
        'fw_jump.bin': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin'),
        'fw_dynamic.bin': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_dynamic.bin'),
        'fw_jump.bin.rv32': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin.rv32'),
        'fw_dynamic.bin.rv32': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_dynamic.bin.rv32'),
        'fw_jump.bin.mango': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin.mango'),
    },
    doStepIf=lambda step: step.build.getProperty('QEMU_TESTS', default=False),
    waitForFinish=False))

riscv_factory02.addStep(steps.Trigger(
    schedulerNames=['opensbi-lab-test-scheduler'],
    set_properties={
        'fw_jump.bin': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin'),
        'fw_dynamic.bin': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_dynamic.bin'),
        'fw_jump.bin.rv32': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin.rv32'),
        'fw_dynamic.bin.rv32': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_dynamic.bin.rv32'),
        'fw_jump.bin.mango': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/fw_jump.bin.mango'),
    },
    doStepIf=lambda step: step.build.getProperty('HARDWARE_TESTS', default=False),
    waitForFinish=False))

c['builders'].append(
    util.BuilderConfig(
        name="opensbi-build",
        project="RISC-V",
        workernames=["builder1"],
        factory=riscv_factory02))

#### 'QEMU TEST' builders

#
# qemu1: test riscv64 Linux kernel in QEMU
#   - QEMU provides default OpenSBI and DTB
#

qemu1 = util.BuildFactory()

qemu1.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                           alwaysUseLatest=True,
                           mode='incremental'))

qemu1.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

qemu1.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/qemu1/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for shared 'latest' directory
qemu1.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image', default='artifacts/latest/riscv64/Image'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

qemu1.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check kernel'),
    ],
    workdir="build/lab"))

qemu1.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/local/qemu-riscv64-kernel.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_QEMU_RISCV64": "/usr/bin/qemu-system-riscv64",
        "LG_IMAGES"      : "$PWD/workspace",
        "LG_LINUX"       : "Image",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-qemu1-riscv64",
        project="RISC-V",
        workernames=["tester1"],
        factory=qemu1))

#
# qemu2: test riscv64 OpenSBI and Linux kernel in QEMU
#   - QEMU provides default DTB
#

qemu2 = util.BuildFactory()

qemu2.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                           alwaysUseLatest=True,
                           mode='incremental'))

qemu2.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

qemu2.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/qemu2/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
qemu2.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image', default='artifacts/latest/riscv64/Image'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

qemu2.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/qemu2/fw_dynamic.bin',
    workerdest='lab/workspace/fw_dynamic.bin',
    name='download default opensbi',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
qemu2.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('fw_dynamic.bin', default='artifacts/latest/riscv64/fw_dynamic.bin'),
    workerdest='lab/workspace/fw_dynamic.bin',
    name='download latest opensbi',
    mode=0o755))

qemu2.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check Linux kernel'),
        util.ShellArg(command=['md5sum', 'workspace/fw_dynamic.bin'], logname='check OpenSBI'),
    ],
    workdir="build/lab"))

qemu2.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/local/qemu-riscv64-full.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_QEMU_RISCV64": "/usr/bin/qemu-system-riscv64",
        "LG_IMAGES"      : "$PWD/workspace",
        "LG_OPENSBI"     : "fw_dynamic.bin",
        "LG_LINUX"       : "Image",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-qemu2-riscv64",
        project="RISC-V",
        workernames=["tester1"],
        factory=qemu2))

#
# qemu3: test riscv32 Linux kernel in QEMU
#   - QEMU provides default OpenSBI and DTB
#

qemu3 = util.BuildFactory()

qemu3.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                           alwaysUseLatest=True,
                           mode='incremental'))

qemu3.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

qemu3.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/qemu3/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for shared 'latest' directory
qemu3.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image', default='artifacts/latest/riscv32/Image'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

qemu3.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check kernel'),
    ],
    workdir="build/lab"))

qemu3.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/local/qemu-riscv32-kernel.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_QEMU_RISCV32": "/usr/bin/qemu-system-riscv32",
        "LG_IMAGES"      : "$PWD/workspace",
        "LG_LINUX"       : "Image",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-qemu3-riscv32",
        project="RISC-V",
        workernames=["tester1"],
        factory=qemu3))

#
# qemu4: test riscv32 OpenSBI and Linux kernel in QEMU
#   - QEMU provides default DTB
#

qemu4 = util.BuildFactory()

qemu4.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                           alwaysUseLatest=True,
                           mode='incremental'))

qemu4.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

qemu4.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/qemu4/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
qemu4.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image', default='artifacts/latest/riscv32/Image'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

qemu4.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/qemu4/fw_dynamic.bin',
    workerdest='lab/workspace/fw_dynamic.bin',
    name='download default opensbi',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
qemu4.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('fw_dynamic.bin.rv32', default='artifacts/latest/riscv32/fw_dynamic.bin'),
    workerdest='lab/workspace/fw_dynamic.bin',
    name='download latest opensbi',
    mode=0o755))

qemu4.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check Linux kernel'),
        util.ShellArg(command=['md5sum', 'workspace/fw_dynamic.bin'], logname='check OpenSBI'),
    ],
    workdir="build/lab"))

qemu4.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/local/qemu-riscv32-full.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_QEMU_RISCV32": "/usr/bin/qemu-system-riscv32",
        "LG_IMAGES"      : "$PWD/workspace",
        "LG_OPENSBI"     : "fw_dynamic.bin",
        "LG_LINUX"       : "Image",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-qemu4-riscv32",
        project="RISC-V",
        workernames=["tester1"],
        factory=qemu4))

#
# qemu5: test riscv64 NOMMU Linux kernel in QEMU
#

qemu5 = util.BuildFactory()

qemu5.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                           alwaysUseLatest=True,
                           mode='incremental'))

qemu5.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

qemu5.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/qemu5/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for shared 'latest' directory
qemu5.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image.nommu.rv64', default='artifacts/latest/riscv-nommu/Image.nommu.rv64'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

qemu5.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check kernel'),
    ],
    workdir="build/lab"))

qemu5.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/local/qemu-riscv64-nommu.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_QEMU_RISCV64": "/usr/bin/qemu-system-riscv64",
        "LG_IMAGES"      : "$PWD/workspace",
        "LG_LINUX"       : "Image",
    }))

qemu5.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['cat', 'console_main'], logname='check console log'),
    ],
    workdir="build/lab"))

c['builders'].append(
    util.BuilderConfig(
        name="test-qemu5-riscv64-nommu",
        project="RISC-V",
        workernames=["tester1"],
        factory=qemu5))

#
# qemu6: test riscv32 NOMMU Linux kernel in QEMU
#

qemu6 = util.BuildFactory()

qemu6.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                           alwaysUseLatest=True,
                           mode='incremental'))

qemu6.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

qemu6.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/qemu6/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for shared 'latest' directory
qemu6.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image.nommu.rv32', default='artifacts/latest/riscv-nommu/Image.nommu.rv32'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

qemu6.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check kernel'),
    ],
    workdir="build/lab"))

qemu6.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/local/qemu-riscv32-nommu.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_QEMU_RISCV32": "/usr/bin/qemu-system-riscv32",
        "LG_IMAGES"      : "$PWD/workspace",
        "LG_LINUX"       : "Image",
    }))

qemu6.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['cat', 'console_main'], logname='check console log'),
    ],
    workdir="build/lab"))

c['builders'].append(
    util.BuilderConfig(
        name="test-qemu6-riscv32-nommu",
        project="RISC-V",
        workernames=["tester1"],
        factory=qemu6))

#### 'LAB TEST' builders for RISC-V projects
#
# - slot1: BananaPi CanMV K230D Zero
# - slot3: MangoPi MQ Pro
# - slot5: OrangePi RV
# - slot6: Sipeed MaixBit
# - slot8: Sipeed LicheePi 4A
#

# slot1: test riscv64 generic kernel on BananPi CanMV K230D Zero

slot1 = util.BuildFactory()

slot1.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                        alwaysUseLatest=True,
                        mode='incremental'))

slot1.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

# For now always use default bananapi-canmv-k230d-zero.dtb image
# FIXME: so far bananapi-canmv-k230d-zero.dtb has not been accepted to the upstream kernel
# FIXME: patch upstream kernel ?
slot1.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot1/bananapi-canmv-k230d-zero.dtb',
    workerdest='lab/workspace/bananapi-canmv-k230d-zero.dtb',
    name='download default dtb',
    mode=0o755))

slot1.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot1/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
slot1.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image', default='artifacts/latest/riscv64/Image'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

slot1.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/bananapi-canmv-k230d-zero.dtb'], logname='check dtb'),
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check kernel'),
        util.ShellArg(command=['labgrid-client', 'places'], logname='check labgrid'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot1.addStep(steps.ShellSequence(
    # do not fail if slot is free
    haltOnFailure=False,
    flunkOnFailure=False,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot1', 'release', '--kick'], logname='force release slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot1.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot1', 'acquire'], logname='acquire slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot1.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/remote/test-bpi-canmv-netboot.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_COORDINATOR" : "192.168.88.25",
        "LG_IMAGES"      : "$PWD/workspace",
        "LG_DTB"         : "bananapi-canmv-k230d-zero.dtb",
        "LG_LINUX"       : "Image",
        "LG_PLACE"       : "slot1",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-bananapi-canmv-k230d-zero",
        project="RISC-V",
        workernames=["tester1"],
        factory=slot1))

# slot3: test riscv64 generic kernel on MangoPi MQ Pro

slot3 = util.BuildFactory()

slot3.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                        alwaysUseLatest=True,
                        mode='incremental'))

slot3.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

# For now always use default jump.bin image
slot3.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot3/jump.bin',
    workerdest='lab/workspace/jump.bin',
    name='download default jump.bin',
    mode=0o755))

# For now always use default sun20i-d1-mangopi-mq-pro.dtb image
# FIXME: For FEL boot we need to patch upstream mangopi-mq-pro dtb and add explicit valid memory node
# FIXME: patch upstream kernel ?
slot3.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot3/sun20i-d1-mangopi-mq-pro.dtb',
    workerdest='lab/workspace/sun20i-d1-mangopi-mq-pro.dtb',
    name='download default dtb',
    mode=0o755))

slot3.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot3/fw_jump.bin',
    workerdest='lab/workspace/fw_jump.bin',
    name='download default opensbi',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
slot3.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('fw_jump.bin.mango', default='artifacts/latest/riscv64/fw_jump.bin.mango'),
    workerdest='lab/workspace/fw_jump.bin',
    name='download latest opensbi',
    mode=0o755))

slot3.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot3/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
slot3.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image', default='artifacts/latest/riscv64/Image'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

slot3.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/jump.bin'], logname='check fsbl'),
        util.ShellArg(command=['md5sum', 'workspace/fw_jump.bin'], logname='check OpenSBI'),
        util.ShellArg(command=['md5sum', 'workspace/sun20i-d1-mangopi-mq-pro.dtb'], logname='check dtb'),
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check kernel'),
        util.ShellArg(command=['labgrid-client', 'places'], logname='check labgrid'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot3.addStep(steps.ShellSequence(
    # do not fail if slot is free
    haltOnFailure=False,
    flunkOnFailure=False,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot3', 'release', '--kick'], logname='force release slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot3.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot3', 'acquire'], logname='acquire slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot3.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/remote/test-mqpro-felboot.yaml', 'tests/test_shell.py::test_version'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_COORDINATOR" : "192.168.88.25",
        "LG_IMAGES"      : "$PWD/workspace",
        "LG_JUMPER"      : "jump.bin",
        "LG_OPENSBI"     : "fw_jump.bin",
        "LG_DTB"         : "sun20i-d1-mangopi-mq-pro.dtb",
        "LG_LINUX"       : "Image",
        "LG_PLACE"       : "slot3",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-mangopi-mqpro",
        project="RISC-V",
        workernames=["tester1"],
        factory=slot3))

# slot5: test riscv64 generic kernel on OrangePi RV

slot5 = util.BuildFactory()

slot5.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                        alwaysUseLatest=True,
                        mode='incremental'))

slot5.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

# For now always use default jh7110-orangepi-rv.dtb image
# FIXME: so far jh7110-orangepi-rv.dts has not yet been accepted to the upstream kernel
# FIXME: patch upstream kernel ?
slot5.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot5/jh7110-orangepi-rv.dtb',
    workerdest='lab/workspace/jh7110-orangepi-rv.dtb',
    name='download default dtb',
    mode=0o755))

slot5.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot5/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
slot5.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image', default='artifacts/latest/riscv64/Image'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

slot5.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/jh7110-orangepi-rv.dtb'], logname='check dtb'),
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check kernel'),
        util.ShellArg(command=['labgrid-client', 'places'], logname='check labgrid'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot5.addStep(steps.ShellSequence(
    # do not fail if slot is free
    haltOnFailure=False,
    flunkOnFailure=False,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot5', 'release', '--kick'], logname='force release slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot5.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot5', 'acquire'], logname='acquire slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot5.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/remote/test-orangepi-rv-netboot.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_COORDINATOR" : "192.168.88.25",
        "LG_IMAGES"      : "$PWD/workspace",
        "LG_DTB"         : "jh7110-orangepi-rv.dtb",
        "LG_LINUX"       : "Image",
        "LG_PLACE"       : "slot5",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-orangepi-rv",
        project="RISC-V",
        workernames=["tester1"],
        factory=slot5))

# slot6: test riscv64 generic kernel on Sipeed MaixBit

slot6 = util.BuildFactory()

slot6.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                        alwaysUseLatest=True,
                        mode='incremental'))

slot6.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

slot6.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot6/loader.bin',
    workerdest='lab/workspace/loader.bin',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
slot6.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('loader.bin.k210', default='artifacts/latest/riscv-nommu/loader.bin.k210'),
    workerdest='lab/workspace/loader.bin',
    name='download latest kernel',
    mode=0o755))

slot6.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/loader.bin'], logname='check kernel'),
        util.ShellArg(command=['labgrid-client', 'places'], logname='check labgrid'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot6.addStep(steps.ShellSequence(
    # do not fail if slot is free
    haltOnFailure=False,
    flunkOnFailure=False,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot6', 'release', '--kick'], logname='force release slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot6.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot6', 'acquire'], logname='acquire slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot6.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/remote/test-sipeed-maixbit-ispboot.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_COORDINATOR": "192.168.88.25",
        "LG_IMAGES"     : "$PWD/workspace",
        "LG_LINUX"      : "loader.bin",
        "LG_PLACE"      : "slot6",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-sipeed-maixbit",
        project="RISC-V",
        workernames=["tester1"],
        factory=slot6))

# slot8: test riscv64 generic kernel on Sipeed LicheePi 4A

slot8 = util.BuildFactory()

slot8.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                        alwaysUseLatest=True,
                        mode='incremental'))

slot8.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['git', 'clean', '-fdxx'], logname='clean'),
    ]))

slot8.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot8/Image',
    workerdest='lab/workspace/Image',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
slot8.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('Image', default='artifacts/latest/riscv64/Image'),
    workerdest='lab/workspace/Image',
    name='download latest kernel',
    mode=0o755))

slot8.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot8/th1520-lichee-pi-4a.dtb',
    workerdest='lab/workspace/th1520-lichee-pi-4a.dtb',
    name='download default dtb',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
slot8.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('th1520-lichee-pi-4a.dtb', default='artifacts/latest/riscv64/th1520-lichee-pi-4a.dtb'),
    workerdest='lab/workspace/th1520-lichee-pi-4a.dtb',
    name='download latest dtb',
    mode=0o755))

slot8.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/th1520-lichee-pi-4a.dtb'], logname='check dtb'),
        util.ShellArg(command=['md5sum', 'workspace/Image'], logname='check kernel'),
        util.ShellArg(command=['labgrid-client', 'places'], logname='check labgrid'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot8.addStep(steps.ShellSequence(
    # do not fail if slot is free
    haltOnFailure=False,
    flunkOnFailure=False,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot8', 'release', '--kick'], logname='force release slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot8.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['labgrid-client', '-p', 'slot8', 'acquire'], logname='acquire slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot8.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/remote/test-lpi4a-netboot.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_COORDINATOR": "192.168.88.25",
        "LG_IMAGES"     : "$PWD/workspace",
        "LG_LINUX"      : "Image",
        "LG_DTB"        : "th1520-lichee-pi-4a.dtb",
        "LG_PLACE"      : "slot8",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-sipeed-lpi4a",
        project="RISC-V",
        workernames=["tester1"],
        factory=slot8))

##############################################################
#################### PROJECT: SUNXI
##############################################################

####### SCHEDULERS

# schedule builds based on source changes

@util.renderer
def select_sunxi_kernel_builders(props):
    props.setProperty('HARDWARE_TESTS', ENABLE_HARDWARE_TESTS, 'select_sunxi_kernel_builders')
    props.setProperty('QEMU_TESTS', ENABLE_QEMU_TESTS, 'select_sunxi_kernel_builders')
    builders = set()

    print("----------------  Changed files")

    for fn in props.files:
        print(f"  {fn}")
        if fn.startswith("arch/arm/"):
            builders.add('sunxi-arm-kernel-build')

    print(f"expected builders: {list(builders)}")
    return list(builders)

c['schedulers'].append(schedulers.SingleBranchScheduler(
                            name="sunxi-kernel-master-scheduler",
                            change_filter=util.ChangeFilter(branch='master', category='kernel'),
                            builderNames=select_sunxi_kernel_builders))

# schedule builds on demands

c['schedulers'].append(schedulers.ForceScheduler(
                            name="force-sunxi-arm-kernel-build",
                            properties=[
                                util.BooleanParameter(name="HARDWARE_TESTS", label="Run hardware tests", default=False),
                                util.BooleanParameter(name="QEMU_TESTS", label="Run QEMU tests", default=False),
                            ],
                            builderNames=["sunxi-arm-kernel-build"]))

c['schedulers'].append(schedulers.ForceScheduler(
                            name="force-sunxi-arm-lab-tests",
                            properties=[
                                util.BooleanParameter(name="DEFAULT_IMAGES", label="Use default images", default=False),
                            ],
                            builderNames=['test-orangepi-pc-plus']))

# trigger builds and tests from other builders

c['schedulers'].append(schedulers.Triggerable(
    name='sunxi-arm-lab-test-scheduler',
    builderNames=['test-orangepi-pc-plus']))

####### BUILDERS

#### 'BUILD' builders

#
# builder: build default sunxi arm kernel
#

sunxi_factory01 = util.BuildFactory()

sunxi_factory01.addStep(steps.Git(repourl=KERNEL_REPO,
                           alwaysUseLatest=True,
                           mode='full',
                           method='fresh'))

sunxi_factory01.addStep(steps.FileDownload(
    haltOnFailure=True,
    mastersrc="artifacts/images/rootfs/rootfs.cpio.arm.sunxi",
    workerdest="rootfs.cpio"))

sunxi_factory01.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['make', 'sunxi_defconfig'], logname='configure'),
        util.ShellArg(command=['make', 'CONFIG_INITRAMFS_SOURCE=rootfs.cpio', '-j5'], logname='build kernel'),
        util.ShellArg(command=['make', 'allwinner/sun8i-h3-orangepi-pc-plus.dtb'], logname='build orangepi-pc-plus dtb'),
    ],
    env={
        "ARCH": "arm",
        "CROSS_COMPILE": "/home/matsi/devel2/tools/bootlin/armv7-eabihf--glibc--bleeding-edge-2025.08-1/bin/arm-linux-",
    }))

# copy to the build artifacts

sunxi_factory01.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/arm/boot/zImage",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/zImage'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/zImage'),
    mode=0o755))

sunxi_factory01.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/arm/boot/dts/allwinner/sun8i-h3-orangepi-pc-plus.dtb",
    masterdest=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/sun8i-h3-orangepi-pc-plus.dtb'),
    url=util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/sun8i-h3-orangepi-pc-plus.dtb'),
    mode=0o755))

# copy to the latest artifacts

# - FIXME: lock needed for the 'latest' directory
sunxi_factory01.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/arm/boot/zImage",
    masterdest=util.Interpolate('artifacts/latest/sunxi/zImage'),
    url=util.Interpolate('artifacts/latest/sunxi/zImage'),
    mode=0o755))

sunxi_factory01.addStep(steps.FileUpload(
    haltOnFailure=True,
    workersrc="arch/arm/boot/dts/allwinner/sun8i-h3-orangepi-pc-plus.dtb",
    masterdest=util.Interpolate('artifacts/latest/sunxi/sun8i-h3-orangepi-pc-plus.dtb'),
    url=util.Interpolate('artifacts/latest/sunxi/sun8i-h3-orangepi-pc-plus.dtb'),
    mode=0o755))

# trigger tests

sunxi_factory01.addStep(steps.Trigger(
    schedulerNames=['sunxi-arm-lab-test-scheduler'],
    set_properties={
        'sun8i-h3-orangepi-pc-plus.dtb': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/sun8i-h3-orangepi-pc-plus.dtb'),
        'zImage': util.Interpolate('artifacts/%(prop:buildername)s-%(prop:buildnumber)s/zImage'),
    },
    doStepIf=lambda step: step.build.getProperty('HARDWARE_TESTS', default=False),
    waitForFinish=False))

c['builders'].append(
    util.BuilderConfig(
        name="sunxi-arm-kernel-build",
        project="SUNXI",
        workernames=["builder1"],
        factory=sunxi_factory01))

#### 'LAB TEST' builders for SUNXI projects
#
# - slot2: OrangePi PC Plus
#

# slot2: test arm sunxi kernel on orange-pi-pc-plus

slot2 = util.BuildFactory()

slot2.addStep(steps.Git(repourl='https://github.com/geomatsi/lab-tests.git',
                           alwaysUseLatest=True,
                           mode='incremental'))

slot2.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot2/zImage',
    workerdest='lab/workspace/zImage',
    name='download default kernel',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
slot2.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('zImage', default='artifacts/latest/sunxi/zImage'),
    workerdest='lab/workspace/zImage',
    name='download latest kernel',
    mode=0o755))

slot2.addStep(steps.FileDownload(
    doStepIf=lambda step: step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc='artifacts/images/default/slot2/sun8i-h3-orangepi-pc-plus.dtb',
    workerdest='lab/workspace/sun8i-h3-orangepi-pc-plus.dtb',
    name='download default dtb',
    mode=0o755))

# FIXME: lock needed for the shared 'latest' directory
slot2.addStep(steps.FileDownload(
    doStepIf=lambda step: not step.build.getProperty('DEFAULT_IMAGES', default=False),
    haltOnFailure=True,
    mastersrc=util.Property('sun8i-h3-orangepi-pc-plus.dtb', default='artifacts/latest/sunxi/sun8i-h3-orangepi-pc-plus.dtb'),
    workerdest='lab/workspace/sun8i-h3-orangepi-pc-plus.dtb',
    name='download latest dtb',
    mode=0o755))

slot2.addStep(steps.ShellSequence(
    haltOnFailure=True,
    commands=[
        util.ShellArg(command=['md5sum', 'workspace/sun8i-h3-orangepi-pc-plus.dtb'], logname='check dtb'),
        util.ShellArg(command=['md5sum', 'workspace/zImage'], logname='check kernel'),
        util.ShellArg(command=['labgrid-client', 'places'], logname='check labgrid'),
        util.ShellArg(command=['labgrid-client', '-p', 'slot2', 'release', '--kick'], logname='force release slot'),
        util.ShellArg(command=['labgrid-client', '-p', 'slot2', 'acquire'], logname='acquire slot'),
    ],
    workdir="build/lab",
    env={
        "LG_COORDINATOR": "192.168.88.25",
    }))

slot2.addStep(steps.ShellCommand(
    haltOnFailure=True,
    command=['pytest', '--lg-log', '--lg-env', 'configs/targets/remote/test-orangepi-pc-netboot.yaml', 'tests/test_shell.py::test_boot'],
    workdir="build/lab",
    logfiles={"console": { "filename": "console_main", "follow": True}},
    env={
        "LG_COORDINATOR": "192.168.88.25",
        "LG_IMAGES"     : "$PWD/workspace",
        "LG_LINUX"      : "zImage",
        "LG_DTB"        : "sun8i-h3-orangepi-pc-plus.dtb",
        "LG_PLACE"      : "slot2",
    }))

c['builders'].append(
    util.BuilderConfig(
        name="test-orangepi-pc-plus",
        project="SUNXI",
        workernames=["tester1"],
        factory=slot2))


